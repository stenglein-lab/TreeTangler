<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Test async es6 function forms</title>
</head>
<body>
<p>This script tests the ES 6 addition of the <code>async</code> and <code>Promise</code> to javascript.</p>
<p>It has been adapted from <a target="_new" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/async_function">https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/async_function</a> to work on data in this repository.
</p>
<p>
Open your javascript console for more information.
</p>
<script src="./d3/d3.min.js"></script>
<script src="./newick.js"></script>
<script>
    // existing files, visible to server
    var newick_file_1 = "./gp.newick";
    var newick_file_2 = "./np.newick";

    // Define a function that returns a new "Promise"
    // This function will be used with the "await" keyword in an "async" function.
    function getNewickFile(url) {
        return new Promise(
            (resolve,reject) => {
                d3.text( url, function(error, parsed_text) {
                    if (error) {
                        console.log("rejecting: " + error); // gives "rejecting [XMLHttpRequest]"
                        reject(error); return;
                    }
                    // Newick.parse does not have an error handler
                    // but could it be called outside of and before "resolve()" 
                    // and the output evaluated for success/failure?
                    resolve( Newick.parse(parsed_text) ); 
                });
            }
        );
    }
    async function readTwoFilesInParallel(url1, url2) {
        /*
        //The "await" kw can be applied directly to the function calls in the return clause 
        return { nw1: await getNewickFile(url1), nw2: await getNewickFile(url2) };
        /*

        /*
        // Alternatively, MDN and other examples use the following form
        var parsedFile1 = getNewickFile(url1);
        var parsedFile2 = getNewickFile(url2);
        return { nw1: await parsedFile1, nw2: await parsedFile2 };
        */

        // To execute the jobs sequentially, use "await" OUTSIDE of the return statement.
        var parsedFile1 = await getNewickFile(url1);
        var parsedFile2 = await getNewickFile(url2);
        return { nw1: parsedFile1, nw2: parsedFile2 };
    }

    readTwoFilesInParallel(newick_file_1, newick_file_2)
        .then(v => {
            console.dir(v);
        })
        .catch(reason => {
            console.log(reason.statusText + ": " + reason.responseURL); 
            // also, response and responseText give a preformatted html message, probably from d3.text(?)
        });
</script>
</body>
</html>
