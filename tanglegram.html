<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="utf-8">
   <!-- boostrap -->
   <!-- Latest compiled and minified CSS -->
   <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">

   <!-- Optional theme -->
   <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap-theme.min.css">

   <!-- boostrap JS and jquery required for that -->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>

   <!-- Styles for figure graphics -->
   <link rel="stylesheet" href="./cophylogeny.css">
   <link rel="stylesheet" href="./map.css">
   <link rel="stylesheet" href="./plots.css">
   <link rel="stylesheet" href="./fasta.css">

   <meta name="viewport" content="width=device-width, initial-scale=1">

</head>
<style>
   body,html {
      height:100%;
   }

	pre {
	   font-size: 8pt;
	}
</style>
<body onload="load()">

<script src="./d3/d3.min.js"></script> 
<script src="http://d3js.org/topojson.v1.min.js"></script>
<script src="./newick.js"></script>
<script src="./CoPhylogenyGraph.js"></script>
<script>
class FileByLines  {
    constructor(filetext) {
        this.fileText = filetext;
        this.lines = filetext.split(/\r\n|\r|\n/g); // accounts for the three NEWLINE types

        // split: final line separator before EOF will result in a blank line
        if (! this.lines[this.lines.length-1]) {
            this.lines.splice(this.lines.length-1, 1); // delete final array element if blank
        }
        console.dir(this.lines);
    }

    *nextLine() {
        for (var i in this.lines) {
            var line = this.lines[i];
            yield line;
        }
    }
}
function processFile(files) {
    var file = files[0];
    var reader = new FileReader();
    reader.readAsText(file);
    reader.onload = function(evt) {
        var filetext = evt.target.result;
        var filer = new FileByLines(filetext);
        var leftToRight = d3.map();
        var rightToLeft = d3.map();

        var lineGenerator = filer.nextLine();
        var line = lineGenerator.next(); // line has 2 properties: value and done
        while (!line.done)
        {
            //console.dir(line);
            if (line.value) { // final newline splits to an empty array value
                var fields = line.value.split(/\s+/);
                leftToRight.set( fields[0],  fields[1] );
                rightToLeft.set( fields[1],  fields[0] );

            }
            else {
                console.log("skipping empty line");
            }
            line = lineGenerator.next();
        } 
        console.dir( leftToRight );
        console.dir( rightToLeft );
    };

}
function load() {
    // URL blobs needed for newick reader
    var leftURL = null, 
        rightURL = null;

    console.log("load...");
    var fileButtonLeft = document.getElementById("fileButtonLeft"),
        fileInputLeft = document.getElementById("fileInputLeft");
    var fileButtonMiddle = document.getElementById("fileButtonMiddle"),
        fileInputMiddle = document.getElementById("fileInputMiddle");
    var fileButtonRight = document.getElementById("fileButtonRight"),
        fileInputRight = document.getElementById("fileInputRight");

    fileButtonLeft.addEventListener("click", function (e) {
      if (fileInputLeft) {
        fileInputLeft.click();
      }
    }, false);
    fileButtonMiddle.addEventListener("click", function (e) {
      if (fileInputMiddle) {
        fileInputMiddle.click();
      }
    }, false);
    fileButtonRight.addEventListener("click", function (e) {
      if (fileInputRight) {
        fileInputRight.click();
      }
    }, false);
}

function clear(selector)
{
	selector = selector.replace("#",""); // # not necessary for getElementById (only for css/d3)
	var myNode = document.getElementById(selector);
	while (myNode.firstChild) {
	    myNode.removeChild(myNode.firstChild);
	}
}
function getBlobURL(files) {
    var file = files[0];
    var fileURL = window.URL.createObjectURL(file);
    return fileURL;
    //window.URL.revokeObjectURL(fileURL);
}
function setLeftURL(files) {
    fileButtonLeft.innerHTML = files[0].name;
    // switch the button to something indicating success
    fileButtonLeft.classList.remove("btn-default");
    fileButtonLeft.classList.add("btn-success");
    leftURL = getBlobURL(files);
    console.log("leftURL:" + leftURL);
    if (typeof rightURL === 'undefined') { console.log("rightURL is undefined."); }
    else {
        callRender();
    }
}
function setRightURL(files) {
    fileButtonRight.innerHTML = files[0].name;
    // switch the button to something indicating success
    fileButtonRight.classList.remove("btn-remove");
    fileButtonRight.classList.add("btn-success");
    rightURL = getBlobURL(files);
    console.log("rightURL:" + rightURL);
    if (typeof leftURL === 'undefined') { console.log("leftURL is undefined."); }
    else {
        callRender();
    }
}

function callRender() {
    render_cophylogeny('#left_container', 'unnamed', leftURL, rightURL, 700);
}

function render_cophylogeny(container_id, segment_id, newick_url_1, newick_url_2, height)
{
	var container_sel = d3.select(container_id);
   var w = container_sel.style("width");
	w = parseInt(w);
	// var w = 600;
   var h = height;

   // process newick trees from file upload
   newick_file_1 = newick_url_1;
   newick_file_2 = newick_url_2;

   clear(container_id);
   var cophylogeny_fig = new CoPhylogenyGraph(container_sel, w, h);
   cophylogeny_fig.tree1_name = fileButtonLeft.innerHTML;
   console.log("name1 is " + cophylogeny_fig.tree1_name);
   cophylogeny_fig.tree2_name = fileButtonRight.innerHTML;
   console.log("name2 is " + cophylogeny_fig.tree2_name);
   cophylogeny_fig.render(newick_file_1, newick_file_2, w, h);


   //figures[container_id] = cophylogeny_fig;
   // var cophylogeny_fig = cophylogeny.render(container_id, newick_file_1, newick_file_2, w, h);
   // figures[container_id] = cophylogeny_fig;
}
</script>
<div class="container-fluid">

  <!-- Static navbar -->
  <nav class="navbar navbar-default" role="navigation">
    <div class="container-fluid">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="javascript:void(0)">Tanglegram - rename this</a>
      </div>
      <div id="navbar" class="navbar-collapse collapse">
        <ul class="nav navbar-nav">
          <li class="active"><a href="javascript:void(0)">Home</a></li>
          <li><a href="./about.html">About</a></li>
          <li><a href="./help.html">Help</a></li>
        </ul>
      </div><!--/.nav-collapse -->
    </div><!--/.container-fluid -->
  </nav>
</div>
<div class="container-fluid">
   <div class="row">
      <div class="col-md-12"">
         <h3>Tree Tangler Web Interface</h3>
			<br>
			<br>
      </div>
   </div>
</div>
<div class="container-fluid">
   <div class="row">
      <div class="col-md-5">
        <input type="file" id="fileInputLeft" accept=".nw, .newick" style="display:none" onchange="setLeftURL(this.files)">
        <button id="fileButtonLeft" type="button" class="btn btn-default">
            Upload left-side tree file (newick)
        </button>
      </div>
      <div class="col-md-2">
        <input type="file" id="fileInputMiddle" style="display:none" onchange="processFile(this.files)">
        <button id="fileButtonMiddle" type="button" class="btn btn-default" onchange="processFile(this.files)">
            Upload lookup file (text)
        </button>
		</div>
      <div class="col-md-5">
        <input type="file" id="fileInputRight" accept=".nw, .newick" style="display:none" onchange="setRightURL(this.files)">
        <button id="fileButtonRight" type="button" class="btn btn-default">
            Upload right-side tree file (newick)
        </button>
      </div>
    </div><!--/.row -->

<!-- spacer -->
<div class="container-fluid">
<p></p>
</div>

<!-- empty containers to be populated by various figs -->
<div class="container-fluid">
   <div class="row">
      <div class="col-md-6" id="left_container">
      </div >
      <div class="col-md-6" id="right_container">
      </div >
   </div>
</div>

</body>
</html>

